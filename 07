<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ‹‰éœ¸æŠ½çï¼ˆCSV/è²¼ä¸Š + GitHub åŒæ­¥ï¼Œç„¡éŸ³æ•ˆç‰ˆï¼‰</title>
<style>
:root{ --bg:#22060a; --panel:#2b0a0e; --text:#fff3e6; --muted:#ffd7b3; --gold:#ffd166; }
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:radial-gradient(circle at 50% 0%, #5a0d12 0%, #22060a 55%, #170408 100%);color:var(--text);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial}

/* ç‰ˆé¢ */
.app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

/* æ´»å‹•åç¨± */
.header{ text-align:center; padding:10px 12px 0 }
#eventTitle{ margin:0; font-weight:900; letter-spacing:.5px; font-size:clamp(18px, 4.8vw, 36px); color:#ffe9cc; text-shadow:0 2px 6px rgba(0,0,0,.35) }

/* èˆå° */
.stage{ display:grid; place-items:center; padding:8px 8px 130px; position:relative }
.machine{
  position:relative; width:min(96vw, 96vh); max-width:1200px;
  background:linear-gradient(#b40f1e,#9b0c19);
  padding:16px 14px 24px; border-radius:22px;
  box-shadow: inset 0 12px 0 rgba(255,255,255,.15), inset 0 -14px 0 rgba(0,0,0,.25), 0 18px 40px rgba(0,0,0,.6);
  border:6px solid #7d0914;
}
.machine .bezel{ border-radius:16px; padding:12px; background:linear-gradient(#ffdfa1,#ffcf54); box-shadow:inset 0 4px 10px rgba(0,0,0,.25); }

/* è¦–çª— */
.machine .window{
  height:clamp(240px, 62vh, 560px);
  display:block; border-radius:14px; background:linear-gradient(#fff7eb,#fff3df);
  border:6px solid #ffe49c; box-shadow:inset 0 6px 18px rgba(0,0,0,.15);
  position:relative; overflow:hidden;
}

/* è½‰è»¸ï¼šä¸€æ ¼=è¦–çª—é«˜åº¦ */
#slotReel{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:stretch;
  gap:0; padding:0; will-change:transform;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  backface-visibility: hidden;
}
.slotItem{
  display:grid; place-items:center;
  font-weight:900; letter-spacing:.5px; color:#a02400;
  background:linear-gradient(#fff7eb,#fff0da);
  width:100%; border-radius:12px; border:2px solid #ffdca0;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  font-size:clamp(28px, 5.6vw, 64px); padding:10px 12px;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  backface-visibility: hidden;
}

/* çµæœè¦†è“‹æ•´å€‹è¦–çª—ï¼ˆæ°¸é åœ¨æœ€ä¸Šå±¤ï¼‰ */
#resultOverlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:6 }
#resultOverlay .pill{
  width:min(86%, 900px); padding:18px 26px; border-radius:18px;
  background:rgba(255,255,255,.97); border:5px solid var(--gold); color:#8a1c00;
  font-weight:900; letter-spacing:.5px; box-shadow:0 14px 36px rgba(0,0,0,.45);
  font-size:clamp(34px, 6.6vw, 84px); text-align:center;
}

/* æŒ‰éˆ• */
.controls{ display:grid; place-items:center; margin-top:14px }
#spinBtn{
  width:min(80%,420px); height:80px; border-radius:18px; border:none; cursor:pointer;
  font-weight:900; font-size:clamp(20px,3.6vw,30px); color:#fffaf0; text-shadow:0 2px 2px rgba(0,0,0,.25);
  background:linear-gradient(#ff3b3b,#d81826);
  box-shadow:inset 0 -10px 0 rgba(0,0,0,.25), 0 10px 20px rgba(0,0,0,.45);
}
#spinBtn:active{ transform:translateY(1px) }

/* å½©å¸¶ */
#confetti{ position:absolute; inset:0; pointer-events:none; z-index:5 }

/* å¾Œå°æŠ½å±œï¼ˆå« GitHub åŒæ­¥ï¼‰ */
.drawer{ position:fixed; left:0; right:0; bottom:0; z-index:9999; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.08)); }
.drawer-toggle{ display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:8px 0; border:none; background:transparent; color:#ffe3bf; cursor:pointer }
.drawer-toggle span{font-size:12px; opacity:.9}
.drawer-panel{ max-height:0; overflow:hidden; transition:max-height .35s ease; background:var(--panel); border-top:1px solid #571019 }
.drawer.open .drawer-panel{ max-height:60dvh }
.panel-inner{ padding:12px; display:grid; gap:12px }
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#4a0f16; border:1px solid #6e1620; font-size:12px; color:#ffdcb0}
.small{font-size:12px; color:#ffd7b3}
input,button,textarea,select{background:#3a0d14; color:#ffe9cc; border:1px solid #6e1620; border-radius:8px; padding:8px 10px}
textarea{min-height:76px}
button{cursor:pointer}
.btn{padding:8px 12px; border-radius:10px; border:1px solid #6e1620; background:#3a0d14}
.btn-primary{border-color:#ffb74d; background:#ffb74d; color:#5a2200; font-weight:800}
.btn-ok{border-color:#0aa37f; background:#0aa37f; color:#04120d; font-weight:800}
.btn-warn{border-color:#d97706; background:#d97706; color:#2b1300; font-weight:800}
.table{width:100%; border-collapse:collapse}
.table th,.table td{border-bottom:1px dashed #6e1620; padding:6px; text-align:left; font-size:13px}
.table th{color:#ffd7b3}
.right{text-align:right}

/* æ‡¸æµ®å¾Œå°æŒ‰éˆ•ï¼ˆå‚™ç”¨ï¼‰ */
.fab{
  position:fixed; right:14px; bottom:90px; z-index:10000;
  background:#ffb74d; color:#5a2200; border:none; border-radius:999px; padding:10px 14px; font-weight:900; cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}

/* æç¤º */
.toast{ position:fixed; left:50%; top:18px; transform:translateX(-50%); background:#3a0d14; border:1px solid #6e1620; padding:8px 14px; border-radius:10px; color:#ffe9cc; opacity:0; transition:.35s; pointer-events:none }
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="app">
  <div class="header"><h1 id="eventTitle">2025 æ´»å‹•æŠ½ç</h1></div>

  <div class="stage">
    <div class="machine" id="machine">
      <div class="bezel">
        <div class="window" id="slotWindow">
          <div id="slotReel"></div>
          <div id="resultOverlay"><div class="pill" id="centerText">æº–å‚™å°±ç·’</div></div>
        </div>
      </div>
      <div class="controls"><button id="spinBtn">ç«‹å³æŠ½ç</button></div>
      <canvas id="confetti"></canvas>
    </div>
  </div>

  <!-- åº•éƒ¨æŠ½å±œ -->
  <div class="drawer" id="drawer">
    <button class="drawer-toggle" id="drawerToggle" aria-expanded="false">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m6 15 6-6 6 6"/></svg>
      <span>å¾Œå°è¨­å®š</span>
    </button>
    <div class="drawer-panel" id="drawerPanel">
      <div class="panel-inner">
      
        <!-- åŒ¯å…¥çé …ï¼ˆCSV / è²¼ä¸Šï¼‰ -->
        <div class="row">
          <span class="badge">åŒ¯å…¥çé …ï¼ˆCSV æˆ–è²¼ä¸Šï¼‰</span>
          <input type="file" id="csvFile" accept=".csv" />
          <button class="btn" id="importBtn">åŒ¯å…¥</button>
          <button class="btn-warn" id="resetBtn">é‡ç½®çé …</button>
          <span class="small">CSV æ¬„ä½ï¼š<code>name,weight,color(optional),enabled(optional)</code></span>
        </div>
        <textarea id="pasteArea" placeholder="ä¸€ç­‰ç,1,#FFD166,true
äºŒç­‰ç,2,,true
ä¸‰ç­‰ç,3,,true
è¬è¬åƒèˆ‡,6,#FFE3A0,true"></textarea>

        <!-- GitHub åŒæ­¥ï¼ˆCSVï¼‰ -->
        <div class="row">
          <span class="badge">GitHub åŒæ­¥ï¼ˆCSVï¼‰</span>
          <input id="ghRepo" value="defangmall/lucky" style="min-width:260px"/>
          <input id="ghBranch" placeholder="main" style="width:110px"/>
          <input id="ghPath" placeholder="data/prizes07.csv" style="min-width:200px"/>
          <input id="ghToken" type="password" placeholder="GitHub Tokenï¼ˆå…¬æœ‰ repo è¼‰å…¥å¯ç•™ç©ºï¼Œæ¨é€å¿…å¡«ï¼‰" style="min-width:260px"/>
        </div>
        <div class="row">
          <button class="btn" id="loadFromGitHub">å¾ GitHub è¼‰å…¥</button>
        </div>

        <!-- è¨­å®š -->
        <div class="row">
          <label class="badge">æŠ½çæ¨¡å¼</label>
          <label class="row small"><input type="checkbox" id="allowRepeat"/> å…è¨±åŒä¸€çé …é‡è¤‡é–‹å‡º</label>
          <label class="row small"><input type="checkbox" id="deterministic"/> å¯é‡ç¾æ¨¡å¼</label>
          <input id="seedInput" placeholder="ï¼ˆä¾‹å¦‚ï¼š2025æŠ½çï¼‰" style="min-width:220px"/>
          <span class="badge">è½‰å‹•ç§’æ•¸</span>
          <input type="number" id="spinSec" min="1" max="15" step="0.5" value="1" style="width:90px"/>
          <button class="btn-ok" id="downloadLog">ä¸‹è¼‰ç´€éŒ„ CSV</button>
        </div>

        <!-- ç›®å‰çé … -->
        <div>
          <table class="table" id="prizeTable">
            <thead><tr><th>åç¨±</th><th class="right">æ¬Šé‡</th><th>é¡è‰²</th><th>å•Ÿç”¨</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ç´€éŒ„ -->
        <div>
          <h4 style="margin:8px 0 6px">æŠ½çç´€éŒ„</h4>
          <table class="table" id="logTable">
            <thead><tr><th>æ™‚é–“</th><th>çµæœ</th><th>æ¬Šé‡</th><th>æ¨¡å¼/ç¨®å­</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- æ‡¸æµ®å¾Œå°æŒ‰éˆ• -->
  <button class="fab" id="fabToggle">âš™ å¾Œå°</button>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ===== å·¥å…· ===== */
const $ = s => document.querySelector(s);
const nowISO = () => new Date().toISOString();
function toast(msg){ const t = $('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
function csvEscape(s){ if(s==null) return ""; s=String(s); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
function mulberry32(seed){ let t = seed>>>0; return function(){ t += 0x6D2B79F5; let r = Math.imul(t ^ t>>>15, 1 | t); r ^= r + Math.imul(r ^ r>>>7, 61 | r); return ((r ^ r>>>14)>>>0)/4294967296; } }
async function seedFromString(str){ if(!str) str=String(Date.now()); const enc=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256', enc); const view=new DataView(hash); return view.getUint32(0,true); }

/* ===== ç‹€æ…‹ ===== */
let prizes = [
  {name:'ä¸€ç­‰ç', weight:1, color:'#FFD166', enabled:true, removed:false},
  {name:'äºŒç­‰ç', weight:2, color:'#FFE3A0', enabled:true, removed:false},
  {name:'ä¸‰ç­‰ç', weight:3, color:'#FFD166', enabled:true, removed:false},
  {name:'è¬è¬åƒèˆ‡', weight:6, color:'#FFE3A0', enabled:true, removed:false},
];
let deterministic=false, seedNote='', prng=null, logs=[];

/* ===== å¾Œå°æŠ½å±œ ===== */
const drawer = $('#drawer'), drawerToggle = $('#drawerToggle'), fabToggle = $('#fabToggle');
function toggleDrawer(forceOpen){
  const open = (typeof forceOpen==='boolean') ? forceOpen : !drawer.classList.contains('open');
  drawer.classList.toggle('open', open);
  drawerToggle?.setAttribute('aria-expanded', open);
}
drawerToggle?.addEventListener('click', ()=>toggleDrawer());
fabToggle?.addEventListener('click', ()=>toggleDrawer());


/* ===== è½‰è»¸å…§å®¹ï¼šä¸€æ ¼ = è¦–çª—é«˜åº¦ ===== */
const windowEl = $('#slotWindow');
const reel = $('#slotReel');
function buildReel(){
  reel.innerHTML = '';
  const active = prizes.filter(p=>p.enabled && !p.removed && p.weight>=0);
  const pool = [...active, ...active, ...active, ...active];
  const itemH = windowEl.clientHeight; // ä¸€æ ¼ = è¦–çª—é«˜
  pool.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'slotItem';
    div.style.borderColor = p.color || '#FFD166';
    div.style.height = itemH + 'px';
    div.textContent = p.name;
    reel.appendChild(div);
  });
  reel.style.transform = `translateY(0px)`;
}
window.addEventListener('resize', buildReel);

/* ===== åŒ¯å…¥ï¼ˆCSV / è²¼ä¸Šï¼‰ ===== */
$('#importBtn').addEventListener('click', async ()=>{
  let text = '';
  const f = $('#csvFile').files[0];
  if(f){ text = await f.text(); } else { text = $('#pasteArea').value.trim(); }
  if(!text){ toast('è«‹å…ˆé¸æ“‡ CSV æˆ–è²¼ä¸Šæ–‡å­—'); return; }
  text = text.replace(/\uFEFF/g,'');
  const out = csvTextToPrizes(text);
  if(!out.length){ toast('æ²’æœ‰è§£æåˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªæ¬„ä½æ ¼å¼'); return; }
  prizes = out; buildReel(); renderPrizeTable();
  $('#centerText').textContent = 'åå–®å·²åŒ¯å…¥'; toast(`å·²åŒ¯å…¥ ${out.length} å€‹çé …`);
});

$('#resetBtn').addEventListener('click', ()=>{
  prizes.forEach(p=>{ p.removed=false; p.enabled=true; });
  buildReel(); renderPrizeTable();
  $('#centerText').textContent = 'å·²é‡ç½®';
});

/* CSV æ–‡å­— â†’ prizes é™£åˆ— */
function csvTextToPrizes(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  if(!lines.length) return [];
  let rows = lines;
  const head = lines[0].split(',').map(s=>s.trim().toLowerCase());
  const hasHeader = head.includes('name') || head.includes('weight');
  if(hasHeader) rows = lines.slice(1);
  const out = [];
  rows.forEach(line=>{
    const [name,weight,color,enabled] = line.split(',').map(s=>s?.trim());
    if(!name) return;
    out.push({ name, weight: Number(weight||1)||0, color: color||null, enabled: (enabled==null||enabled==='') ? true : /^(true|1|yes|y)$/i.test(enabled), removed:false });
  });
  // è‡ªå‹•é…è‰²ï¼ˆç´…é‡‘ï¼‰
  const auto = ['#FFD166','#FFE3A0'];
  out.forEach((p,i)=>{ if(!p.color) p.color = auto[i%2]; });
  return out;
}

/* ===== ç›®å‰çé …è¡¨ ===== */
function renderPrizeTable(){
  const tb = $('#prizeTable tbody'); tb.innerHTML = '';
  prizes.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${p.name}" data-i="${i}" data-k="name"/></td>
      <td class="right"><input type="number" min="0" step="0.1" value="${p.weight}" data-i="${i}" data-k="weight" style="width:100px"/></td>
      <td><input type="color" value="${p.color||'#FFD166'}" data-i="${i}" data-k="color" style="padding:0 4px;width:70px"/></td>
      <td><select data-i="${i}" data-k="enabled"><option value="true"${p.enabled?' selected':''}>å•Ÿç”¨</option><option value="false"${!p.enabled?' selected':''}>åœç”¨</option></select></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('change', ()=>{
      const i = Number(el.getAttribute('data-i'));
      const k = el.getAttribute('data-k');
      let v = el.value;
      if(k==='weight') v = Number(v)||0;
      if(k==='enabled') v = (v==='true');
      prizes[i][k] = v;
      buildReel();
    });
  });
}

/* ===== é è¨­ GitHub ä¾†æºï¼ˆå…¬æœ‰ repo å¯ä¸å¡« tokenï¼‰===== */
const GH_DEFAULTS = {
  repo:  "defangmall/lucky",   // â† æ”¹æˆä½ çš„ owner/repo
  branch:"main",                    // â† é è¨­åˆ†æ”¯
  path:  "data/prizes07.csv",         // â† CSV è·¯å¾‘
  token: ""                         // ç§æœ‰ repo æ‰éœ€è¦ï¼›å‰ç«¯ä¸å»ºè­°ç¡¬ç·¨
};



  
/* ===== RNG / æ¬Šé‡æŠ½é¸ ===== */
function rng(){ return deterministic && prng ? prng() : crypto.getRandomValues(new Uint32Array(1))[0]/2**32; }
function pickPrize(){
  const pool = prizes.map((p,i)=>({p,i})).filter(x=>x.p.enabled && !x.p.removed && x.p.weight>0);
  const total = pool.reduce((a,b)=>a + Number(b.p.weight||0), 0);
  if(total<=0 || pool.length===0) return null;
  let r = rng() * total;
  for(const x of pool){ r -= Number(x.p.weight||0); if(r <= 0) return x; }
  return pool[pool.length-1];
}

/* ===== å‹•ç•«ï¼šæ¯æ¬¡å¾ 0 é–‹å§‹ï¼Œåœåœ¨æ•´æ ¼ ===== */
let spinning = false;
function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
async function spinToLabel(targetName, sec=1){
  if(spinning) return;
  spinning = true;

  const itemH = windowEl.clientHeight;
  const totalItems = reel.children.length;

  // æ‰¾ç¬¬ä¸€å€‹åŒåç´¢å¼•
  let targetIndex = -1;
  for(let i=0;i<totalItems;i++){
    if(reel.children[i].textContent === targetName){ targetIndex = i; break; }
  }
  if(targetIndex<0) targetIndex = totalItems-1;

  const cycles = 10 + Math.floor(Math.random()*5);
  const startY = 0;
  const endY   = -(cycles*itemH + targetIndex*itemH);

  const start = performance.now(), dur = sec*1000;
  function frame(t){
    const k = Math.min(1, (t-start)/dur);
    const eased = (k<0.2)? (k/0.2)*0.3 : (k>0.8)? 0.3 + (k-0.8)/0.2*0.7 : 0.3 + (k-0.2)/0.6*0.4;
    const y = startY + (endY-startY)*easeOutCubic(eased);
    reel.style.transform = `translateY(${y}px)`;
    if(k<1) requestAnimationFrame(frame); else spinning=false;
  }
  return new Promise(res=>{
    requestAnimationFrame(frame);
    setTimeout(()=>{
      reel.style.transform = `translateY(${Math.round(endY)}px)`; // snap
      res();
    }, dur+20);
  });
}

/* ===== å½©å¸¶ï¼ˆç°¡æ˜“ï¼‰ ===== */
const confetti = document.getElementById('confetti'); const cctx = confetti.getContext('2d');
function resizeConfetti(){ const rect = document.getElementById('machine').getBoundingClientRect(); confetti.width = rect.width; confetti.height = rect.height; }
window.addEventListener('resize', resizeConfetti); resizeConfetti();
let confettiAnim = null;
function launchConfetti(durationMs=2200){
  cancelConfetti();
  const W = confetti.width, H = confetti.height;
  const colors = ['#FFD166','#FFE3A0','#fff','#ff4d4d'];
  const parts = Array.from({length:140}, (_,i)=>({
    x: W/2 + (Math.random()*80-40), y: H*0.15 + (Math.random()*40-20),
    vx: (Math.random()*2-1)* (2 + Math.random()*3), vy:  - (4 + Math.random()*3),
    g: 0.12 + Math.random()*0.08, w: 6 + Math.random()*6, h: 10 + Math.random()*10,
    rot: Math.random()*Math.PI, vr: (Math.random()*0.2-0.1), color: colors[i%colors.length]
  }));
  const start = performance.now();
  function tick(t){
    const elapsed = t - start; cctx.clearRect(0,0,W,H);
    parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.rot+=p.vr;
      cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot);
      cctx.fillStyle=p.color; cctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); cctx.restore();
    });
    if(elapsed < durationMs){ confettiAnim = requestAnimationFrame(tick); }
  }
  confettiAnim = requestAnimationFrame(tick);
}
function cancelConfetti(){ if(confettiAnim){ cancelAnimationFrame(confettiAnim); confettiAnim=null; } cctx.clearRect(0,0,confetti.width,confetti.height); }

/* ===== æŠ½çæµç¨‹ ===== */
document.getElementById('spinBtn').addEventListener('click', async ()=>{
  if(spinning) return;
  if(document.getElementById('deterministic').checked && !deterministic){ await setupDeterministic(); }

  const pick = pickPrize();
  if(!pick){ toast('ç›®å‰æ²’æœ‰å¯å‡ºççš„é …ç›®ï¼ˆæ¬Šé‡=0 æˆ–å…¨éƒ¨åœç”¨ï¼‰'); return; }

  document.getElementById('centerText').textContent = 'æŠ½çä¸­â€¦';
  cancelConfetti();

  const sec = Math.max(1, Number(document.getElementById('spinSec').value)||1);
  await spinToLabel(pick.p.name, sec);

  document.getElementById('centerText').textContent = `ğŸ‰ ${pick.p.name} ğŸ‰`;
  launchConfetti();

  const mode = deterministic ? 'å¯é‡ç¾' : 'å®‰å…¨äº‚æ•¸';
  logs.push({ts:nowISO(), name:pick.p.name, weight:pick.p.weight, mode, seed:seedNote});
  appendLogRow(logs[logs.length-1]);

  if(!document.getElementById('allowRepeat').checked){
    prizes[pick.i].removed = true; prizes[pick.i].enabled = false;
  }
  buildReel(); renderPrizeTable();
});

/* ===== ç´€éŒ„è¡¨ ===== */
function appendLogRow(r){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${r.ts}</td><td>${csvEscape(r.name)}</td><td>${r.weight}</td><td>${r.mode}${r.seed?` / ${csvEscape(r.seed)}`:''}</td>`;
  document.querySelector('#logTable tbody').prepend(tr);
}

document.getElementById('downloadLog').addEventListener('click', ()=>{
  if(logs.length===0) return toast('é‚„æ²’æœ‰ç´€éŒ„');
  const header = ['timestamp','prize','weight','mode','seed'];
  const rows = logs.map(x => [x.ts,x.name,x.weight,x.mode,x.seed].map(csvEscape).join(','));
  download(`slot_logs_${Date.now()}.csv`, [header.join(',')].concat(rows).join('\n'));
});

/* ===== å¯é‡ç¾äº‚æ•¸ ===== */
document.getElementById('deterministic').addEventListener('change', async ()=>{
  if(document.getElementById('deterministic').checked){ await setupDeterministic(); }
  else { deterministic=false; prng=null; seedNote=''; toast('å·²åˆ‡æ›åˆ°å®‰å…¨äº‚æ•¸');}
});
document.getElementById('seedInput').addEventListener('change', async ()=>{ if(document.getElementById('deterministic').checked){ await setupDeterministic(); }});
async function setupDeterministic(){
  deterministic = true;
  seedNote = document.getElementById('seedInput').value.trim() || `(timestamp:${Date.now()})`;
  const seed = await seedFromString(seedNote);
  prng = mulberry32(seed);
  toast('å¯é‡ç¾æ¨¡å¼å•Ÿç”¨');
}

/* ===== GitHub åŒæ­¥ï¼ˆCSVï¼‰ ===== */
function toBase64UTF8(str){ return btoa(unescape(encodeURIComponent(str))); }
async function getGitHubFileSHA({owner, repo, path, branch, token}){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  const res = await fetch(url, { headers: { ...(token?{Authorization:`Bearer ${token}`}:{}), Accept:'application/vnd.github+json' } });
  if (res.status === 404) return null;
  if (!res.ok) throw new Error(`get SHA å¤±æ•—ï¼šHTTP ${res.status}`);
  const json = await res.json();
  return json.sha || null;
}
function buildPrizesCSV(prizesArr){
  const header = ['name','weight','color','enabled'];
  const rows = prizesArr.map(p => [
    csvEscape(p.name),
    csvEscape(p.weight ?? ''),
    csvEscape(p.color ?? ''),
    csvEscape(p.enabled ? 'true' : 'false')
  ].join(','));
  return [header.join(','), ...rows].join('\n');
}
async function pushPrizesToGitHub({owner, repo, path, branch='main', token}){
  if(!/\.csv$/i.test(path)) throw new Error('è«‹å°‡ Path ä»¥ .csv çµå°¾');
  const contentStr = buildPrizesCSV(prizes);
  const contentB64 = toBase64UTF8(contentStr);
  const sha = await getGitHubFileSHA({owner, repo, path, branch, token}).catch(()=>null);
  const url  = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = { message: `chore: update prizes07.csv (${new Date().toISOString()})`, content: contentB64, branch };
  if (sha) body.sha = sha;
  const res = await fetch(url, {
    method:'PUT',
    headers:{ Authorization:`Bearer ${token}`, Accept:'application/vnd.github+json', 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if(!res.ok){ const txt = await res.text().catch(()=> ''); throw new Error(`æ¨é€å¤±æ•—ï¼šHTTP ${res.status} ${txt.slice(0,200)}`); }
  return res.json();
}
  
async function loadPrizesFromGitHub({owner, repo, path, branch='main', token}) {
  // æ­£ç¢ºè™•ç†è·¯å¾‘ç·¨ç¢¼ï¼šé€æ®µ encodeï¼Œä¸è¦æŠŠæ–œç·šç·¨æ‰
  const apiPath = String(path).split('/').map(encodeURIComponent).join('/');
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${apiPath}?ref=${encodeURIComponent(branch)}`;
  const headers = { Accept: 'application/vnd.github+json' };
  if (token) headers.Authorization = `Bearer ${token}`;

  const res = await fetch(url, { headers, cache: 'no-store' });
  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`è®€å–å¤±æ•—ï¼šHTTP ${res.status} ${txt.slice(0,120)}`);
  }
  const json = await res.json();

  // å¤§æª”ï¼ˆ>1MBï¼‰æ”¹æŠ“ download_url
  if (json.size > 1024*1024 && json.download_url) {
    const r2 = await fetch(json.download_url, { cache:'no-store' });
    if (!r2.ok) throw new Error(`ä¸‹è¼‰éå¤§æª”æ¡ˆå¤±æ•—ï¼šHTTP ${r2.status}`);
    const bigText = await r2.text();
    const out = csvTextToPrizes(bigText.replace(/\uFEFF/g,''));
    if (!out.length) throw new Error('CSVï¼ˆlargeï¼‰è§£æä¸åˆ°è³‡æ–™');
    return out;
  }

  if (!/\.csv$/i.test(json.name || path)) throw new Error('é ç«¯æª”æ¡ˆä¸æ˜¯ .csv');
  const base64 = (json.content || '').replace(/\n/g,'');
  if (!base64) throw new Error('é ç«¯ç„¡å…§å®¹ï¼ˆcontent ç‚ºç©ºï¼‰');

  // base64 -> UTF-8
  const text = decodeURIComponent(escape(atob(base64)));
  if (/<!doctype html>|<html/i.test(text)) throw new Error('æ”¶åˆ° HTMLï¼ˆå¤šåŠæ˜¯æ¬Šé™ä¸è¶³æˆ–è·¯å¾‘éŒ¯ï¼‰');

  const out = csvTextToPrizes(text.replace(/\uFEFF/g,''));
  if (!out.length) throw new Error('CSV è§£æä¸åˆ°è³‡æ–™');
  return out;
}



/* ===== é–‹é è‡ªå‹•å¾ GitHub è¼‰å…¥ï¼ˆå¤±æ•—å°±éœé»˜ç•¥éï¼‰ ===== */
async function autoLoadFromGitHubOnOpen(){
  const sourceRepo   = GH_DEFAULTS.repo;
  const sourceBranch = GH_DEFAULTS.branch || 'main';
  const sourcePath   = GH_DEFAULTS.path   || 'data/prizes07.csv';
  const sourceToken  = GH_DEFAULTS.token  || "";

  if(!sourceRepo) return;
  const [owner, repo] = String(sourceRepo).split('/');
  if(!owner || !repo) return;

  try{
    const out = await loadPrizesFromGitHub({ owner, repo, path: sourcePath, branch: sourceBranch, token: sourceToken });
    if(Array.isArray(out) && out.length){
      prizes = out; buildReel(); renderPrizeTable();
      document.getElementById('centerText').textContent = 'å·²è‡ªå‹•è¼‰å…¥ GitHub çé …';
      toast(`å·²è¼‰å…¥ ${out.length} å€‹çé …ï¼ˆGitHubï¼‰`);
      return;
    }
  }catch(err){
    console.warn('Contents API å¤±æ•—ï¼š', err?.message || err);
    // å…¬é–‹ repo å‚™æ´ï¼šraw
    if (!sourceToken) {
      try{
        const rawPath = sourcePath.split('/').map(encodeURIComponent).join('/');
        const rawUrl  = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(sourceBranch)}/${rawPath}`;
        const r = await fetch(rawUrl, { cache:'no-store' });
        if (r.ok) {
          const text = await r.text();
          const out2 = csvTextToPrizes(text.replace(/\uFEFF/g,''));
          if (out2.length) {
            prizes = out2; buildReel(); renderPrizeTable();
            document.getElementById('centerText').textContent = 'å·²è‡ªå‹•è¼‰å…¥ GitHubï¼ˆraw å‚™æ´ï¼‰';
            toast(`å·²è¼‰å…¥ ${out2.length} å€‹çé …ï¼ˆraw.githubusercontent.comï¼‰`);
          }
        }
      }catch(e2){
        console.warn('raw å‚™æ´éŒ¯èª¤ï¼š', e2?.message || e2);
      }
    }
  }
}


  
/* ç¶å®š GitHub æŒ‰éˆ• */
document.getElementById('loadFromGitHub')?.addEventListener('click', async ()=>{
  const repoFull = document.getElementById('ghRepo')?.value.trim();
  const branch   = document.getElementById('ghBranch')?.value.trim() || 'main';
  const path     = document.getElementById('ghPath')?.value.trim() || 'data/prizes07.csv';
  const token    = document.getElementById('ghToken')?.value.trim();
  if(!repoFull){ toast('è«‹å¡« owner/repo'); return; }
  const [owner, repo] = repoFull.split('/');
  if(!owner || !repo){ toast('owner/repo æ ¼å¼ä¸æ­£ç¢º'); return; }
  try{
    toast('è®€å–ä¸­â€¦');
    const out = await loadPrizesFromGitHub({owner, repo, path, branch, token});
    prizes = out; buildReel(); renderPrizeTable();
    $('#centerText').textContent = 'å·²å¾ GitHub è¼‰å…¥';
    toast(`å·²è¼‰å…¥ ${out.length} å€‹çé …`);
  }catch(e){ console.error(e); toast(String(e.message||e)); }
});

/* ===== åˆå§‹åŒ– ===== */
function init(){
  document.getElementById('allowRepeat').checked = false;
  document.getElementById('deterministic').checked = false;
  document.getElementById('seedInput').value = '';
  buildReel(); renderPrizeTable();
  autoLoadFromGitHubOnOpen();
}
init();
</script>
</body>
</html>
